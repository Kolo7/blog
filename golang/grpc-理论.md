# GO-微服务技术栈

### 为什么选择gRPC？

gRPC是在HTTP / 2之上实现的现代RPC协议。HTTP / 2是第7层（应用程序层）协议，它运行在TCP（第4层-传输层）协议的顶部，而该协议在IP（第3层-网络层）协议的顶部运行。gRPC有很多优点：

1. 二进制协议（HTTP / 2）；
2. 在一个连接（HTTP / 2）上复用多个请求；
3. 标头压缩（HTTP / 2）；
4. 强类型服务和消息定义（Protobuf）；
5. 多种语言的惯用客户端/服务器库实现。

此外，gRPC与生态系统组件无缝集成，例如服务发现，名称解析器，负载平衡器，跟踪和监视等。

### 负载均衡（Load balancing options）

负载均衡有两种模式：代理（proxy）和客户端（client），代理又称为服务器端。

在代理负载平衡中，客户端向负载平衡器（LB）代理发出RPC。LB将RPC调用分发到实现了实际服务调用逻辑的可用后端服务器之一。LB跟踪每个后端的负载，并实现用于公平分配负载的算法。客户端本身不了解后端服务器。客户可能不受信任。

### Raft算法

​		Raft算法是一种用来管理日志复制的一致性算法。Raft将一致性算法分成了几个部分，包括了领导选取，日志复制，安全性。

​	Raft算法有几个新的特性：

1. 强领导者：日志条目只从领导者发送向其他服务器。这样就简化了对日志复制的管理。
2. 领导选取：Raft 使用随机定时器来选取领导者。它使得在解决冲突时更简单和快速。
3. 成员变化：Raft 为了调整集群中成员关系使用了新的联合一致性（joint consensus），这种方法中大多数不同配置的机器在转换关系的时候会交迭（overlap）。这使得在配置改变的时候，集群能够继续操作。

##### 状态

在所有服务器上持久存在的：（在响应远程过程调用 RPC 之前稳定存储的）

|    名称     |                             描述                             |
| :---------: | :----------------------------------------------------------: |
| currentTerm |            服务器最后知道的任期号（从0开始递增）             |
|  votedFor   |     在当前任期内收到选票的候选人 id（如果没有就为 null）     |
|    log[]    | 日志条目；每个条目包含状态机的要执行命令和从领导人处收到时的任期号 |

在所有服务器上不稳定存在的：

|    名称     |                       描述                        |
| :---------: | :-----------------------------------------------: |
| commitIndex | 已知的被提交的最大日志条目的索引值（从0开始递增） |
| lastApplied | 被状态机执行的最大日志条目的索引值（从0开始递增） |

在领导人服务器上不稳定存在的：（在选举之后初始化的）

|     名称     |                             描述                             |
| :----------: | :----------------------------------------------------------: |
| nextIndex[]  | 对于每一个服务器，记录需要发给它的下一个日志条目的索引（初始化为领导人上一条日志的索引值+1） |
| matchIndex[] | 对于每一个服务器，记录已经复制到该服务器的日志的最高索引值（从0开始递增） |

##### 附加日志远程过程调用 （AppendEntries RPC）

由领导人来调用复制日志，也会用作heartbeat。

|     参数     |                             描述                             |
| :----------: | :----------------------------------------------------------: |
|     term     |                        领导人的任期号                        |
|   leaderId   |         领导人的 id，为了其他服务器能重定向到客户端          |
| prevLogIndex |                  最新日志之前的日志的索引值                  |
| prevLogTerm  |               最新日志之前的日志的领导人任期号               |
|  entries[]   | 将要存储的日志条目（表示 heartbeat 时为空，有时会为了效率发送超过一条） |
| leaderCommit |                  领导人提交的日志条目索引值                  |

| 返回值  |                             描述                             |
| :-----: | :----------------------------------------------------------: |
|  term   |           当前的任期号，用于领导人更新自己的任期号           |
| success | 如果其它服务器包含能够匹配上 prevLogIndex 和 prevLogTerm 的日志时为真 |

**接受者需要实现：**

1. 如果 `term < currentTerm`返回 false
2. 如果在`prevLogIndex`处的日志的任期号与`prevLogTerm`不匹配时，返回 false
3. 如果一条已经存在的日志与新的冲突（index 相同但是任期号 term 不同），则删除已经存在的日志和它之后所有的日志
4. 添加任何在已有的日志中不存在的条
5. 如果`leaderCommit > commitIndex`，将`commitIndex`设置为`leaderCommit`和最新日志条目索引号中较小的一个

> 第一条是为了保障term小的更新不被接受；第二条保障接受更新情况下，本机和leader状态一致；第三条保障 ；