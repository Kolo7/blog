# Redis

### Redis事务

- Redis事务通过`MULTLI`、`EXEC`、`DISCARD`、`WATCH`、`UNWATCH`四个命令完成。
- Redis所有的单个命令都是原子性的。需要确保原子性的是命令集合。
- Redis将命令集合序列化并且保证同一事务的命令集合连续且不被打断的执行。
- Redis不支持回滚。

### Redis持久化

- RDB
- AOF

##### RDB方案

默认的持久化方案。

RDB通过快照机制完成持久化。当符合一定条件时Redis会自动将内存中的数据快照并持久化到硬盘。

- 触发快照的时机

1. 符合自定义配置的快照规则。
2. 执行save或者是bgsave命令。
3. 执行flushall命令。
4. 执行主从复制命令。

Redis在启动时会自动的读取RDB快照文件。

##### RDB快照原理

1. Redis调用操作系统fork函数复制一份当前进程的副本。
2. 父进程继续处理命令，子进程执行写入磁盘临时文件操作。
3. 子进程完全执行完后会用临时文件替代旧的RDB文件。

##### RDB优缺点

- 缺点：一旦异常退出Redis，会丢失最后一次快照之后更改的所有数据。
- 优点：可以最大化Redis的性能。

##### AOF方式

默认不启动AOF方式。

##### 触发AOF的时机

每执行一条更改Redis中数据的命令，将该命令写入硬盘中的AOF文件。这会降低Redis的性能。

##### 写入硬盘的时机

因为数据写入硬盘存在缓存读写机制，在AOF中可以设置该机制：

1. always（同步写）
2. everysec（每秒写，默认）
3. no（缓存满了才写）

##### AOF重写原理

Redis启动AOF会让AOF文件逐渐增大，当过大时自动进行重写，重写后的AOF文件包含了恢复数据集所需的最小命令集。

可以设置重写策略改变重写时机。

##### AOF文件损坏修复

当服务器在对AOF文件写入时停机，会导致AOF损坏，重启Redis时会拒绝载入该文件。需要使用Redis自带工具修复后才能载入使用。

##### 持久化的选择

如果对数据安全性要求高，应该同时使用两者。

如果可以承受部分数据丢失，只使用RDB。

不推荐单独使用AOF。

### Redis主从复制

- 在主从结构中，slave做备份功能。当master宕机时，slave开始提供服务。
- master和slave的数据保持实时更新。
- 只有一个master，可以有多个slave。
- 主从复制不会阻塞master的工作。
- 一个Redis既可以是master，也可以是slave。

##### 主从复制原理

- 分全量同步和增量同步。
- slave只有第一次连接master是全量同步。
- 断线重连两种同步都有可能，由master判断runid是否一致。
- 其他情况都是增量同步。

##### 全量同步

- 同步快照阶段，master传快照给slave，并且将这个期间产生的写命令写入缓冲。
- 同步写缓冲阶段，slave同步缓冲中的写命令。
- 同步增量阶段，slave增量同步。

##### 增量同步

- 指slave初始化后开始正常工作，master的写命令同步到slave的过程。
- 通常，master每执行一条命令就会发给slave，slave接受并执行。

### 哨兵机制

主从复制机制没法动态选举，需要Sentinel机制完成动态选举。

- Sentinel机制进程用于监控Redis集群中Master的状态。
- 在Master发生故障时，切换Master和Slave。

##### 哨兵的作用

- 监控：不断通过ping/pang机制检查master和slave是否存活。

- 提醒：当监控下的某个Redis发生故障，会通知管理者。

- 自动故障迁移：当一个Master不能正常工作时。哨兵开始自动迁移机制。

  - 从失效的master的slave中选择一个升级为新的master，让原来master的slave全部改为复制新的master。
  - 当客户端连接失效master时，集群向客户端返回新的master的地址。
  - 自动改变master和slave的配置文件。说明不能自动恢复原来的master。

##### 切换流程

- 当哨兵发送心跳超时，认定主观下线。
- 通知其他哨兵，如果总是总哨兵数超过设定值认为主观下线时，则该master客观下线。
- 选出一个哨兵（raft算法），一般是发现的哨兵，启动自动故障迁移。
- 如果原master复活，那么作为新的master的slave。

  









 